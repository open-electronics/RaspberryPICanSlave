<!DOCTYPE html>
<html>
<head>

<script>
	
   function getXmlHttpRequestObject()
   {
      if (window.XMLHttpRequest)
      {
			 return new XMLHttpRequest();
      }else if (window.ActiveXObject)
      {
			 return new ActiveXObject("Microsoft.XMLHTTP");
      }
      else
      {
			 alert("Your Browser does not support AJAX!\nIt's about time to upgrade don't you think?");
		}
	 }
 
//XmlHttpRequest global object
 var req = getXmlHttpRequestObject();

// Main interval to poll the Slaves status from server
var SnapShotInterval = setInterval(getRequestRefresh, 500);

var Seconds = 0;
var HandlerCounter = 0;
// Synch Callback for showing the total number of frames and the related fps
setInterval(IncreaseFreqCount, 1000);

function IncreaseFreqCount()
{
	Seconds = Seconds + 1;
	Num = HandlerCounter / Seconds;
	txt = HandlerCounter.toFixed(1)
	document.getElementById("frames").innerHTML = txt;
	txt = HandlerCounter.toFixed(1) + "/" + Seconds.toFixed(1) + "=" + Num.toFixed(1);
	document.getElementById("fps").innerHTML=txt;
}

function ParseXML(xmlDoc)
{
   if (xmlDoc == null)
      return;
   // Fill the main table
   x = xmlDoc.getElementsByTagName("Tag");
   txt = "<table border='1'><tr><th>CAN ID</th><th>Relays</th><th>Time to Expire</th></tr>";
   // Check if the Slaves list is empty
   if (x.length == 0)
   {
      txt = txt + "<tr>";
      txt = txt + "<td>" + "No Slaves present on the CAN Bus" + "</td>";
      txt = txt + "</tr>";
   }
   else
   {
      // Build the MasterTable
      for (i = 0; i < x.length; i++)
      {
         txt = txt + "<tr>";
         txt = txt + "<td>" + x[i].getAttribute('ID') + "</td>";
         // TODO: Relays
         txt = txt + "<td>" + "</td>";
         // Dump Time to Expire
         var Now = x[i].getAttribute('NOW_TS');
         var TS = x[i].getAttribute('TS');
         var TimeToExpire = Now - TS;
         txt = txt + "<td>" + TimeToExpire + "</td>";
      }
   }
   txt = txt + "</table>";
   document.getElementById('MasterTable').innerHTML = txt;
}


function handleResponse()
{
   if (req.readyState == 4)
   {
      ParseXML(req.responseXML);
      HandlerCounter = HandlerCounter + 1;
   }
}

function getRequestRefresh()
 {
	 getRequest('/data/SnapShot.xml', 'Refresh', handleResponse);
 }

function getRequest(resource, command, handleResponse)
 {
	// Stop SnapShot interval until this request will have been served
	// handle the case where a querystring is not detected
	String = resource + "?" + 'Cmd=' + command + "&" + 'ms=' + new Date().getTime();
	//alert(String);
	
	if (req.readyState == 4 || req.readyState == 0)
	{
		 req.open("GET", String, true);
	 	 req.onreadystatechange = handleResponse;
	 	 req.send(null);
	 	 return false;
 	}
}

</script>

</head>
<body>

<div id='MasterTable'></div><br>
<div id='frames'></div><br>
<div id='fps'></div><br>

</body>
</html>
