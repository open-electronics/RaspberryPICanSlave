<!DOCTYPE html>
<html>
<head>

   <style>
      table, td {
         border: 1px solid black;
      }
   </style>

   <script>

   function getXmlHttpRequestObject()
   {
      if (window.XMLHttpRequest)
      {
			 return new XMLHttpRequest();
      }else if (window.ActiveXObject)
      {
			 return new ActiveXObject("Microsoft.XMLHTTP");
      }
      else
      {
			 alert("Your Browser does not support AJAX!\nIt's about time to upgrade don't you think?");
		}
	 }

//XmlHttpRequest global object
 var req = getXmlHttpRequestObject();
// Main interval to poll the Slaves status from server
var SnapShotInterval = setInterval(getRequestRefresh, 500);
var Seconds = 0;
var HandlerCounter = 0;
// Synch Callback for showing the total number of frames and the related fps
setInterval(IncreaseFreqCount, 1000);

function IncreaseFreqCount()
{
	Seconds = Seconds + 1;
	Num = HandlerCounter / Seconds;
	txt = HandlerCounter.toFixed(1)
	document.getElementById("frames").innerHTML = txt;
	txt = HandlerCounter.toFixed(1) + "/" + Seconds.toFixed(1) + "=" + Num.toFixed(1);
	document.getElementById("fps").innerHTML=txt;
}

function chooseUser(entry, Idx)
{
    switch (entry)
    {
        case 1:
            alert("Set" + Idx);
            break;
        case 2:
            alert("Reset" + Idx);
            break;
        case 3:
            alert("Toggle" + Idx);
            break;
    }
}

function UpdateRelay(ExtTD, Value, SlaveIdx, Idx)
{
	var TD;
	// If an ExtTD is given, use it otherwise retrieve building its Id
	if (ExtTD != null)
		TD = ExtTD;
	else
	{
		var Id = "S" + SlaveIdx + "R" + Idx;
		TD = document.getElementById(Id);
		console.log(TD);
	}
	if (TD != null) 
	{
	   console.log("S" + SlaveIdx + "R" + Idx + ": FOUND!!! " + "Value = " + Value);
	   if (Value == 1) 
	   {
	      TD.style.backgroundColor = "green";
	      TD.nodeValue = "ON";
	   }
	   else 
	   {
	      TD.style.backgroundColor = "red";
	      TD.nodeValue = "OFF";
	   }
	}
}

function CreateRelay(Row, Idx, Value, SlaveIdx)
{
    var z = document.createElement("TD");
	
	z.id = "S" + SlaveIdx + "R" + Idx;

    var btn = document.createElement('input');
    btn.type = "button";
    btn.className = "btn";
    btn.style.width = "100%";
    btn.value = "Set";
    btn.onclick = (function(entry, Idx) {return function() {chooseUser(entry, Idx);}})(1, Idx);

    z.appendChild(btn);
    var br = document.createElement("br");
    z.appendChild(br);
    var btn = document.createElement('input');
    btn.type = "button";
    btn.className = "btn";
    btn.style.width = "100%";
    btn.value = "Reset";
    btn.onclick = (function(entry, Idx) {return function() {chooseUser(entry, Idx);}})(2, Idx);
    z.appendChild(btn);
     var br = document.createElement("br");
    z.appendChild(br);
    var btn = document.createElement('input');
    btn.type = "button";
    btn.className = "btn";
    btn.style.width = "100%";
    btn.value = "Toggle";
    btn.onclick = (function(entry, Idx) {return function() {chooseUser(entry, Idx);}})(3, Idx);
    z.appendChild(btn);
    var br = document.createElement("br");
    z.appendChild(br);
    var t = document.createTextNode("0");

    z.appendChild(t);
	// Update the cell text value and background color
	UpdateRelay(z, Value, SlaveIdx, Idx);

    Row.appendChild(z);
}

function UpdateAliveStuff(TTE, SlaveIdx)
{
   console.log("L1-" + SlaveIdx);
   var label = document.getElementById("L1-" + SlaveIdx);
   if (label != null)
   {
      var c = label.childNodes;
      if (c != null) {
         if (TTE > 0)
            c.nodeValue = "Slave Is Alive";
         else
            c.nodeValue = "Slave Is Out Of Date";
      }
      if (TTE > 0)
         label.style.color = "green";
      else
         label.style.color = "red";
   }
}

function CreateSlave(Row, ID, Relays, TTE, SlaveIdx)
{
    // Create a cell for the Slave ID
    var z = document.createElement("TD");
    Row.appendChild(z);
    var t = document.createTextNode(ID);
    z.appendChild(t);

    // Create the relays cells
    for (i = 0; i < Relays.length; i++)
        CreateRelay(Row, i, Relays[i], SlaveIdx);

   // Create the Slave Status
    var z = document.createElement("TD");
    Row.appendChild(z);
    var label = document.createElement('label');
    label.id = "L1-" + SlaveIdx;
    label.appendChild(t);
   // Update the just created text
    UpdateAliveStuff(TTE, SlaveIdx);

    z.appendChild(label);
    var br = document.createElement("br");
    z.appendChild(br);
    var br = document.createElement("br");
    z.appendChild(br);
    String = "Time to Expire: " + TTE + "s";
    var t = document.createTextNode(String);
    z.appendChild(t);
}

function UpdateSlave(table, CANId, Row, Relays, ExpireTS)
{
	console.log("Update");
   // Gets the children <td> from 1 -> Relays.length and update them text/colors
   var RowChildren = Row.childNodes;
   for (i=0; i < Relays.length; i++)
   {
	   UpdateRelay(null, Relays[i], 0, i);
	   


   }
}

function AppendSlave(table, CANId, Relays, ExpireTS, SlaveIdx)
{
	console.log("Append");
	
	table.innerHTML = "";

	var Row = document.createElement("TR");
   // Assign an Id to the row == CANId. This will be used ti check
   // whether an existing Slave is already present, in order to update
   // its entry, instead of rebuilding from scratch.
   Row.id = CANId;

   table.appendChild(Row);

   CreateSlave(Row, CANId, Relays, ExpireTS, SlaveIdx);
}

function ParseXML(xmlDoc)
{
   if (xmlDoc == null)
      return;
   // Fill the main table
   x = xmlDoc.getElementsByTagName("Slave");
   var table = document.getElementById('MasterTable');
   //Check if the Slaves list is empty
   if (x.length == 0)
   {
      txt = txt + "<tr>";
      txt = txt + "<td>" + "No Slaves present on the CAN Bus" + "</td>";
      txt = txt + "</tr>";
   }
   else
   {
      var Id, Row;

      // Build/update the MasterTable
	   for (i = 0; i < x.length; i++)
	   {
	      Id = x[i].getAttribute('ID');
	      // Just for debug (TODO: 2B read from the XML)
	      var Relays = [1, 0, 1, 0];
	      //var Relays = x[i].childNodes;
	      var ExpireTS = 2.3;
	      // Search if there's an existing matching Id row in the HTML
	      Row = document.getElementById(Id);
	      if (Row == null)
	         AppendSlave(table, Id, Relays, ExpireTS, i);
	      else
	         UpdateSlave(table, Id, Row, Relays, ExpireTS);
	   }
   }
}

function handleResponse()
{
   if (req.readyState == 4)
   {
      ParseXML(req.responseXML);
      HandlerCounter = HandlerCounter + 1;
   }
}
function getRequestRefresh()
 {
	 getRequest('/data/SnapShot.xml', 'Refresh', handleResponse);
 }
function getRequest(resource, command, handleResponse)
 {
	// Stop SnapShot interval until this request will have been served
	// handle the case where a querystring is not detected
	String = resource + "?" + 'Cmd=' + command + "&" + 'ms=' + new Date().getTime();
	//alert(String);

	if (req.readyState == 4 || req.readyState == 0)
	{
		 req.open("GET", String, true);
	 	 req.onreadystatechange = handleResponse;
	 	 req.send(null);
	 	 return false;
 	}
}
   </script>

</head>
<body>

   <div id='MasterTable'></div><br>
   <div id='frames'></div><br>
   <div id='fps'></div><br>

</body>
</html>